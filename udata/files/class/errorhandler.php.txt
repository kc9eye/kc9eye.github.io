<?php
/* This file is part of UData.
 * Copyright (C) 2018 Paul W. Lane <kc9eye@outlook.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; version 2 of the License.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
Class Errorhandler {

    public $LogFile;
    public $ErrorXML;
    public $ErrorID;
    public $SupportLink;

    public function __construct ($log_file='error_log.xml',$support_link = null) {
        $this->LogFile = $log_file;
        $this->SupportLink = $support_link;
        set_error_handler([$this, 'ErrorHandler']);
        set_exception_handler([$this, 'ExceptionHandler']);
    }

    public function ErrorHandler ($code,$msg,$file,$line,$trace) {
        if (!is_null($trace) && is_array($trace)) {
            $trace = htmlentities(print_r($trace,true));
        }
        else {
            $trace = htmlentities($trace);
        }
        $this->PrepareXML($code,$msg,$file,$line,$trace);
        $this->WriteLog ();
        if (($code === E_USER_NOTICE) || ($code === E_USER_WARNING)) {
            return true;
        }
        else {
            $this->DisplayErrorScreen();
            die();
        }
    }

    public function ExceptionHandler ($e) {
        $this->ErrorHandler(
            $e->getCode(),
            $e->getMessage(),
            $e->getFile(),
            $e->getLine(),
            $e->getTraceAsString()
        );
    }

    protected function PrepareXML ($code, $msg, $file, $line, $trace = null) {
        $this->ErrorID = uniqid('ERR_');
        $xml = '<error><id>'.$this->ErrorID.'</id>';
        $xml .= '<date>'.date('c').'</date>';
        $xml .= '<number>'.$code.'</number>';
        $xml .= '<message><![CDATA['.$msg.']]></message>';
        $xml .= '<file><![CDATA['.$file.']]></file>';
        $xml .= '<line>'.$line.'</line>';
        if (!is_null($trace)) {
            $xml .= '<trace><![CDATA['.$trace.']]></trace>';
        }
        $xml .= '</error>';
        $this->ErrorXML = $xml;
    }

    protected function WriteLog () {
        if (file_exists($this->LogFile)) {
            $this->AppendLog();
        }
        else {
            $this->CreateLog();
        }
    }

    protected function AppendLog () {
        $fh = fopen($this->LogFile, 'c');
        flock($fh,LOCK_EX);
        fseek($fh,-13,SEEK_END);
        fwrite($fh,$this->ErrorXML);
        fwrite($fh,"\n</error_log>\n");
        flock($fh,LOCK_UN);
        fclose($fh);
    }

    protected function CreateLog () {
        $fh = fopen($this->LogFile, 'w');
        flock($fh,LOCK_EX);
        fwrite($fh,"<?xml version='1.0' ?>\n");
        fwrite($fh,"<error_log>\n");
        fwrite($fh,$this->ErrorXML);
        fwrite($fh,"\n</error_log>\n");
        flock($fh,LOCK_UN);
        fclose($fh);
    }

    private function DisplayErrorScreen () {
        $oldbuff = ob_get_contents();
        ob_clean();
        
        if (is_null($this->SupportLink) || $this->SupportLink == '') {
            $this->SupportLink = 'mailto:webadmin@'.$_SERVER['SERVER_NAME'].'?Subject:'.$this->ErrorID;
        }
?>
<!DOCTYPE html>
<html>
    <head>
        <title>Fatal Exception</title>
        <style>
            html, body, .container {
                background-color:blue;
                color:white;
                font-size:22px;
                height:100%;
            }
            .container {
                position: relative;
            }
            .centered {
                position:absolute;
                top:33%;
                margin-left:33%;
                margin-right:33%;
            }
            a {
                color:white;
            }
        </style>
    </head>
    <body>
        <div class='container'>
            <div class='centered'>
                <h1>Fatal Exception</h1>
                <b>ID:</b>&nbsp;<?php echo $this->ErrorID;?><br />
                <p>
                    A fatal exception has occurred at: 0x<?php echo dechex(time());?> 
                    and the application can not continue.
                    Please use the above reference number when contacting the 
                    adminstrator about the error. <br />
                    <b>END OF LINE</b>
                </p>
                <a href='<?php echo $this->SupportLink;?>'>Contact Support</a>
            </div>
        </div>
    </body>
</html>
<?php
    }
}
