<?php
/* This file is part of Udata.
 * Copyright (C) 2018 Paul W. Lane <kc9eye@outlook.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; version 2 of the License.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
Class ViewMaker {

    public $ViewData;
    public $PageData;
    protected $security;
    protected $sideNav;
    protected $config;

    public function __construct (Security $security = null, $config) {
        $this->security = $security;
        $this->config = $config;
        $this->sideNav = false;
        $this->PageData['approot'] = $config['application-root'];
        $this->PageData['wwwroot'] = $config['application-root'].'/wwwroot';
        $this->PageData['companyName'] = $config['company-name'];
        $this->PageData['companyMotto'] = $config['company-motto'];
        $this->PageData['navbarBrand'] = $config['home-name'];
    }

#The views header information
    public function header () {
?>
<!DOCTYPE html>
<html>
    <head>
        <title><?php echo $this->ViewData['pagetitle'];?></title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="Copyright" content="2018 Paul W. Lane" />
        <meta name="License" content="MIT" />
        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="msapplication-TileImage" content="<?php echo $this->PageData['wwwroot'];?>/images/favicons/ms-icon-144x144.png">
        <meta name="theme-color" content="#ffffff">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
        <link rel="stylesheet" href="<?php echo $this->PageData['wwwroot'];?>/css/dark-header.css" />
        <link rel="stylesheet" href="<?php echo $this->PageData['wwwroot'];?>/css/print.css" />
        <link rel="apple-touch-icon" sizes="57x57" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/apple-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="60x60" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/apple-icon-60x60.png">
        <link rel="apple-touch-icon" sizes="72x72" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/apple-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="76x76" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/apple-icon-76x76.png">
        <link rel="apple-touch-icon" sizes="114x114" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/apple-icon-114x114.png">
        <link rel="apple-touch-icon" sizes="120x120" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/apple-icon-120x120.png">
        <link rel="apple-touch-icon" sizes="144x144" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/apple-icon-144x144.png">
        <link rel="apple-touch-icon" sizes="152x152" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/apple-icon-152x152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/apple-icon-180x180.png">
        <link rel="icon" type="image/png" sizes="192x192"  href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/android-icon-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="96x96" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/favicon-96x96.png">
        <link rel="icon" type="image/png" sizes="16x16" href="<?php echo $this->PageData['wwwroot'];?>/images/favicons/favicon-16x16.png">
        <link rel="manifest" href="<?php echo $this->PageData['wwwroot'];?>/scripts/manifest.json">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="<?php echo $this->PageData['wwwroot'];?>/scripts/header.js"></script>
    </head>
    <body>
        <div class='page-header' id='template-header'>
            <h1><?php echo $this->PageData['companyName'];?></h1>
            <span>
                <?php echo $this->PageData['companyMotto'];?>
            </span>
        </div>
        <?php $this->navBar();?>
        <div class="container-float view-content">
<?php
    }


#The views footer information, closes out header tags
    public function footer (Array $script_links = null) {
        if ($this->sideNav) {
            echo "</div></div>\n";
        }
?>
        </div>
        <div class='footer'>
            Copyright (C) 2008-2018 Paul W. Lane<?php $this->insertTab(2);?><a href='<?php echo $this->config['error-support-link'];?>' target='_blank'>Problem with this page?</a>
        </div>
        <?php
        if (!is_null($script_links)) {
            foreach($script_links as $link) {
                echo "<script src='".$link."'></script>\n";
            }
        }
        ?>
    </body>
</html>
<?php
    }

    public function navBar () {
?>
<nav class='navbar navbar-inverse'>
    <div class='container-fluid'>
        <div class='navbar-header'>
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class='navbar-brand' href='<?php if (empty($this->PageData['approot'])){echo '/';} else {echo $this->PageData['approot'];}?>'>
                <?php echo $this->PageData['navbarBrand'];?>
            </a>
        </div>
        <div class='collapse navbar-collapse' id='myNavbar'>
            <ul class='nav navbar-nav'>
                <?php foreach($this->config['navbar-links'] as $label=>$link) {
                    echo "<li><a href='{$this->PageData['approot']}{$link}'>{$label}</a></li>\n";
                }
                ?>
            </ul>
            <ul class='nav navbar-nav navbar-right'>
            <?php
                if (!is_null($this->security->secureUserID)) {
                    $username = is_null($this->security->user['firstname']) ? $this->security->user['email'] : $this->security->user['firstname'];
                    echo "          <li class='dropdown'>\n";
                    echo "              <a href='#' class='dropdown-toggle' data-toggle='dropdown'><span class='glyphicon glyphicon-user'></span>&#160;".$username."&#160;<span class='caret'></span></a>\n";
                    echo "              <ul class='dropdown-menu'>\n";
                    if ($this->security->userHasPermission('adminAll')) {
                        echo "                  <li><a href='{$this->PageData['approot']}/admin/site_admin'><span class='glyphicon glyphicon-cog'></span>&#160;Site Settings</a></li>\n";
                    }
                    echo "                  <li><a href='{$this->PageData['approot']}/user/myaccount'>My Account</a></li>\n";
                    echo "                  <li><a href='{$this->PageData['approot']}/user/logout'>Log Out</a></li>\n";
                    echo "              </ul>\n";
                    echo "          </li>\n";
                }
                else {
                    #$_SESSION['login-redirect'] = $_SERVER['REQUEST_URI']; This can't be implemented until after migration from 3.10. 
                    echo "          <li><a href='{$this->PageData['approot']}/user/createaccount'><span class='glyphicon glyphicon-user'></span> Sign Up</a></li>\n";
                    echo "          <li><a href='{$this->PageData['approot']}/user/login'><span class='glyphicon glyphicon-log-in'></span> Login</a></li>\n";
                }
            ?>
            </ul>
        </div>
    </div>
</nav>
<?php        
    }

    public function offCanvasSideNav (Array $navLinks = null) {
        $this->sideNav = true;
        echo "<div class='row'>\n";
        echo "<div class='col-md-1 col-xs-12'>\n";
        echo "<button type='button' class='btn btn-lg btn-info' id='offCanvasSideNavOpen'>\n";
        echo "Menu<br />";
        echo "<span class='glyphicon glyphicon-forward'></span>\n";
        echo "</button>\n";
        echo "<div id='offCanvasSideNav' class='offCanvasSideNav'>\n";
        echo "<a href='javascript:void(0)' class='closebtn' id='offCanvasSideNavClose'>&times;</a>\n";
        echo "<div class='offCanvasSideNavContent'>\n";
        if (!is_null($navLinks)) {
            foreach($navLinks as $link => $url) {
                if (is_array($url)){
                    if ($this->security->userHasPermission($url[1])) {
                        echo "<a href='{$url[0]}'>{$link}</a>\n";
                    }
                }
                else {
                    echo "<a href='{$url}'>{$link}</a>\n";
                }
            }
        }
        echo "</div>\n";
        echo "</div>\n";
        echo "</div>\n";
        echo "<div class='col-md-11 col-xs-12'>\n";        
    }

    public function preDebug ($debug) {
        echo "<pre class='pre-scrollable'>{$debug}</pre><br />";
    }

    public function sideDropDownMenu (Array $links) {
        $this->sideNav = true;
?>
<div class='row'>
    <div class='col-md-2 col-xs-12'>
        <div class='dropdown'>
            <button class='btn btn-lg btn-info dropdown-toggle' type='button' data-toggle='dropdown'>
                Section Menu <span class='caret'></span>
            </button>
            <ul class='dropdown-menu'>
                <?php
                foreach($links as $item => $info) {
                    if (is_array($info)) {
                        if ($this->security->userHasPermission($info[1])) {
                            echo "<li><a href='{$info[0]}'>{$item}</a></li>\n";
                        }
                        else {
                            echo "<li class='disabled'>{$item}</li>\n";
                        }
                    }
                    else {
                        echo "<li><a href='{$info}'>{$item}</a></li>\n";
                    }
                }
                ?>
            </ul>
        </div>
    </div>
    <div class='col-md-10 col-xs-12 view-content'>
<?php
    }

    public function getFileIcon ($file_name) {
        $ext = @pathinfo($file_name, PATHINFO_EXTENSION);
        $dir = $this->PageData['wwwroot'].'/images/icons';
        if (!empty($ext)) {
            switch ($ext) {
                case 'pdf': $icon = $dir.'/pdf.png';break;
                case 'odt': $icon = $dir.'/odf6odt.png';break;
                case 'doc': $icon = $dir.'/odf6odt.png';break;
                case 'docx': $icon = $dir.'/odf6odt.png';break;
                case 'ods': $icon = $dir.'/odf6ods.png';break;
                case 'xls': $icon = $dir.'/odf6ods.png';break;
                case 'xlsx': $icon = $dir.'/odf6ods.png';break;
                case 'png': $icon = $dir.'/image2.png';break;
                case 'bmp': $icon = $dir.'/image2.png';break;
                case 'gif': $icon = $dir.'/image2.png';break;
                case 'jpg': $icon = $dir.'/image2.png';break;
                case 'odp': $icon = $dir.'/odf6odp.png';break;
                case 'ppt': $icon = $dir.'/odt6odp.png';break;
                case 'pptx': $icon = $dir.'/odt6odp.png';break;
                case 'tar': $icon = $dir.'/tar.png';break;
                case 'tar.gz': $icon = $dir.'/compressed.png';break;
                case 'gz': $icon = $dir.'/compressed.png';break;
                case 'zip': $icon = $dir.'/compressed.png';break;
                case 'iso': $icon = $dir.'/diskimg.png';break;
                case 'exe': $icon = $dir.'/binary.png';break;
                case 'txt': $icon = $dir.'/text.png';break;
                case 'edit': $icon = $dir.'/quill.png';break;
                default: $icon = $dir.'/unknown.png';break;
            }
            return "<img src='{$icon}' alt='[ ? ]' />";
        }
        else {
            return "<img src='{$dir}/unknown.png' alt='[ ? ]' />";
        }
    }

    public function addScrollTopBtn () {
        echo "<button type='button'
                class='btn btn-lg btn-info'
                onclick='document.body.scrollTop=0;document.documentElement.scrollTop=0;'
                id='scrollTopBtn'
                title='Go to top'
                style='display:none;position:fixed;bottom:20px;left:30px;z-index:99;'>
                    <span class='glyphicon glyphicon-arrow-up'></span>&#160;Top
            </button>
            <script>
                $(document).ready(function(){
                    window.onscroll = function() {
                        if (document.body.scrollTop > 20||document.documentElement.scrollTop > 20) {
                            $('#scrollTopBtn').css('display','block');
                        }
                        else {
                            $('#scrollTopBtn').css('display','none');
                        }
                    };
                });
            </script>";
    }

    public function insertTab ($num = 1) {
        for ($cnt = 0; $cnt != $num; $cnt++) {
            echo "&#160;&#160;&#160;";
        }
    }

    public function hr () {
        echo "<hr />\n";
    }
    public function br () {
        echo "<br />\n";
    }

    public function h1 ($content) {
        echo "<h1>{$content}</h1>\n";
    }

    public function h2 ($content) {
        echo "<h2>{$content}</h2>\n";
    }

    public function h3 ($content) {
        echo "<h3>{$content}</h3>\n";
    }

    public function bold ($content) {
        echo "<strong>{$content}</strong>";
    }
}
