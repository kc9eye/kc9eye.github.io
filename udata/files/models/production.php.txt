<?php
/* This file is part of UData.
 * Copyright (C) 2018 Paul W. Lane <kc9eye@outlook.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; version 2 of the License.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
class Production {
    /**
     * @var PDO $dbh The PDO database object
     */
    protected $dbh;

    /**
     * Class constructor
     * @param PDO $dbh A PDO database object
     * @return Production
     */
    public function __construct (PDO $dbh) {
        $this->dbh = $dbh;
    }

    /**
     * Adds an entry to the Quality Control Log
     * 
     * The `$data` array should be in the form
     * `['prokey'=>string,'uid'=>string,serial'=>string,'misc'=>string,'comments'=>string,['qc'=>[1/0,...]]]`
     * The array can contain others, but they are not used or changed.
     * @param Array $data The data to insert
     * @return Boolean
     */
    public function addToQcLog (Array $data) {
        $sql = 
            "INSERT INTO production_log 
             SELECT :id,:prokey,:serial_num,(
                (SELECT count(*) from production_log WHERE prokey = :pkey) + 1
             ),:misc,:ftc,:comments,:uid,now()";
        
        #Calculate FTC
        $qc = count($data['qc']);
        $defect = 0;
        for($cnt=0;$cnt<$qc;$cnt++) {
            if ($data['qc'][$cnt] == 1) $defect++; 
        }
        $ftc = (($defect/$qc) * 100);
        $insert = [
            ':id'=>uniqid(),
            ':prokey'=>$data['prokey'],
            ':pkey'=>$data['prokey'],
            ':serial_num'=>$data['serial'],
            ':misc'=>$data['misc'],
            ':ftc'=>$ftc,
            ':comments'=>$data['comments'],
            ':uid'=>$data['uid']
        ];
        try {
            $pntr = $this->dbh->prepare($sql);
            if (!$pntr->execute($insert)) throw new Exception("Insert failed: {$sql}");
            return true;
        }
        catch (Exception $e) {
            trigger_error($e->getMessage(),E_USER_WARNING);
            return false;
        }

    }
}
